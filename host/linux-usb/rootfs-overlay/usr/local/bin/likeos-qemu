#!/usr/bin/env bash
set -euo pipefail

ISO_PATH=${HOBBY_ISO:-/usr/local/share/likeos/LikeOS-64.iso}
USB_IMG=${HOBBY_USB_IMG:-/usr/local/share/likeos/msdata.img}
RAM_MB=${HOBBY_RAM_MB:-512}
SMP=${HOBBY_SMP:-2}
VIDEO=${HOBBY_DISPLAY:-gtk,gl=off,show-menubar=off,show-tabs=off,grab-on-hover=on}
ACCEL=none
FULLSCREEN=${HOBBY_FULLSCREEN:-off}
FOCUS=${HOBBY_FOCUS:-on}
LOGDIR=/home/likeos/.local/share
LOGFILE=$LOGDIR/likeos-qemu.log
RUNTIME_DIR=${XDG_RUNTIME_DIR:-/run/user/$(id -u)}
MONITOR_SOCK=$RUNTIME_DIR/likeos-qemu.monitor

if [ ! -f "$ISO_PATH" ]; then
    echo "LikeOS ISO not found at $ISO_PATH" >&2
    exit 1
fi
if [ ! -f "$USB_IMG" ]; then
    echo "USB image not found at $USB_IMG" >&2
    exit 1
fi

mkdir -p "$LOGDIR" "$RUNTIME_DIR" || true
chmod 700 "$RUNTIME_DIR" || true

QEMU_ARGS=(
    -m "$RAM_MB"
    -smp "$SMP"
    -bios /usr/share/ovmf/OVMF.fd
    -cdrom "$ISO_PATH"
    -vga std
    -device qemu-xhci,id=xhci
    -device usb-tablet
    -drive if=none,id=usbdisk,file="$USB_IMG",format=raw,readonly=off
    -device usb-storage,drive=usbdisk
    -serial mon:stdio
    -monitor unix:$MONITOR_SOCK,server,nowait
    -display "$VIDEO"
    -no-reboot
    -no-shutdown
)

if [ "$FULLSCREEN" = "on" ]; then
    QEMU_ARGS=( "${QEMU_ARGS[@]}" -full-screen )
fi

case "$ACCEL" in
    kvm)
        QEMU_ARGS=( -enable-kvm -cpu host "${QEMU_ARGS[@]}" )
        ;;
    hvf|whpx)
        QEMU_ARGS=( -accel "$ACCEL" -cpu host "${QEMU_ARGS[@]}" )
        ;;
    none)
        QEMU_ARGS=( -accel tcg,thread=multi -cpu max "${QEMU_ARGS[@]}" )
        ;;
    *)
        QEMU_ARGS=( -accel "$ACCEL" -cpu host "${QEMU_ARGS[@]}" )
        ;;
esac

# Launch QEMU
qemu-system-x86_64 "${QEMU_ARGS[@]}" 2>"$LOGFILE" | tee -a "$LOGFILE" &
QEMU_PID=$!

# Attempt to send hotkeys via monitor once ready
if command -v socat >/dev/null 2>&1; then
    (
        for i in $(seq 1 10); do
            if socat - UNIX-CONNECT:$MONITOR_SOCK 2>/dev/null <<'EOF'
info version
EOF
            then
                socat - UNIX-CONNECT:$MONITOR_SOCK <<'EOF'
sendkey ctrl-alt-f
EOF
                break
            fi
            sleep 1
        done
    ) &
else
    echo "socat not found; cannot auto-send ctrl-alt-f" >>"$LOGFILE"
fi

if [ "$FOCUS" = "on" ]; then
    (
        if command -v wmctrl >/dev/null 2>&1; then
            for i in $(seq 1 15); do
                wmctrl -a "QEMU" 2>/dev/null && break
                sleep 0.5
            done
        elif command -v xdotool >/dev/null 2>&1; then
            for i in $(seq 1 15); do
                win=$(xdotool search --name "QEMU" 2>/dev/null | head -n1) || true
                if [ -n "$win" ]; then
                    xdotool windowactivate "$win" windowfocus "$win"
                    break
                fi
                sleep 0.5
            done
        fi
    ) &
fi

wait $QEMU_PID
